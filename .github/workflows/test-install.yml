name: Test Install Script

on:
  push:
    paths:
      - 'scripts/install.sh'
      - '.github/workflows/test-install.yml'
  pull_request:
    paths:
      - 'scripts/install.sh'
      - '.github/workflows/test-install.yml'
  workflow_dispatch:

jobs:
  # Basic validation
  validate:
    name: Validate Script
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install shellcheck
        run: |
          # Only install if not already available (for act compatibility)
          if ! command -v shellcheck &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y shellcheck
          fi
      - name: Run shellcheck
        run: shellcheck scripts/install.sh

  # Test on major platforms
  test-install:
    name: Test - ${{ matrix.os }}
    needs: validate
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Test installation
        run: |
          ./scripts/install-next.sh
          # Add to PATH for testing
          export PATH="$HOME/.fvm_flutter/bin:$PATH"
          fvm --version
      
      - name: Test reinstall (idempotency)
        run: |
          ./scripts/install-next.sh
          export PATH="$HOME/.fvm_flutter/bin:$PATH"
          fvm --version
      
      - name: Test uninstall
        run: |
          # First ensure FVM is installed
          export PATH="$HOME/.fvm_flutter/bin:$PATH"
          which fvm
          ls -la ~/.fvm_flutter/bin/

          # Run uninstall
          ./scripts/install-next.sh --uninstall

          # Verify uninstall (PATH should be cleared for this check)
          export PATH="$(echo $PATH | tr ':' '\n' | grep -v '.fvm_flutter' | tr '\n' ':')"
          if command -v fvm &>/dev/null; then
            echo "❌ FVM command still exists after uninstall"
            exit 1
          fi

          if [[ -d ~/.fvm_flutter ]]; then
            echo "❌ FVM directory still exists after uninstall"
            exit 1
          fi

          echo "✅ FVM successfully uninstalled"
      
      - name: Test uninstall on clean system (idempotency)
        run: |
          # Run uninstall again - should handle gracefully
          ./scripts/install-next.sh --uninstall

      - name: Test user install (v3 user-local only)
        run: |
          # v3: user install only (no --system flag)
          ./scripts/install-next.sh

          # Verify user install
          test -f ~/.fvm_flutter/bin/fvm || { echo "❌ User install failed"; exit 1; }
          ~/.fvm_flutter/bin/fvm --version || { echo "❌ Binary not working"; exit 1; }

          # Verify no system install
          test ! -f /usr/local/bin/fvm || { echo "❌ Unexpected system install"; exit 1; }

          echo "✅ User install successful"

          # Cleanup
          ./scripts/install-next.sh --uninstall

  # Test container detection and root permissions
  test-container:
    name: Test Container
    needs: validate
    runs-on: ubuntu-latest
    container: ubuntu:latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          apt-get update && apt-get install -y curl tar gzip
      
      - name: Test container root allowed
        run: |
          # v3 installer: user-local install works as root in containers
          ./scripts/install-next.sh
          $HOME/.fvm_flutter/bin/fvm --version
          echo "✅ Container install as root successful"

  # Test root permissions (allowed with warning)
  test-permissions:
    name: Test Permissions
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Test root allowed with warning
        run: |
          # v3 installer: root is allowed but warns
          # Run installation and capture output
          output=$(sudo -H ./scripts/install-next.sh 2>&1)
          echo "$output"

          # Check for root warning
          if echo "$output" | grep -q "Running as root"; then
            echo "✅ Root warning displayed"
          else
            echo "❌ Root warning should be displayed"
            exit 1
          fi

          # Verify install succeeded (use -H to set HOME to /root)
          sudo -H /root/.fvm_flutter/bin/fvm --version || { echo "❌ Install failed"; exit 1; }
          echo "✅ Root install successful"
