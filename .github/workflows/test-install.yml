name: Test Install Script

on:
  push:
    paths:
      - 'scripts/install.sh'
      - '.github/workflows/test-install.yml'
  pull_request:
    paths:
      - 'scripts/install.sh'
      - '.github/workflows/test-install.yml'
  workflow_dispatch:

jobs:
  # Basic validation
  validate:
    name: Validate Script
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install shellcheck
        run: |
          # Only install if not already available (for act compatibility)
          if ! command -v shellcheck &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y shellcheck
          fi
      - name: Run shellcheck
        run: shellcheck scripts/install.sh

  # Test per-user installs on major platforms (no sudo/system copy)
  test-install:
    name: Test - ${{ matrix.os }}
    needs: validate
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    # System (--system) installs require sudo; we keep CI unprivileged and verify
    # that flow manually to avoid running elevated commands on hosted runners.
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install (per-user)
        run: ./scripts/install.sh

      - name: Add FVM bin to PATH
        run: echo "$HOME/.fvm_flutter/bin" >> "$GITHUB_PATH"

      - name: Verify install
        run: |
          set -euo pipefail
          fvm --version
          "$HOME/.fvm_flutter/bin/fvm" --version

      - name: Test reinstall (idempotency)
        run: |
          ./scripts/install.sh
          "$HOME/.fvm_flutter/bin/fvm" --version

      - name: Test uninstall
        run: |
          set -euo pipefail
          ./scripts/install.sh --uninstall
          if command -v fvm &>/dev/null; then
            echo "❌ FVM command still exists after uninstall"
            exit 1
          fi
          if [[ -d "$HOME/.fvm_flutter" ]]; then
            echo "❌ FVM directory still exists after uninstall"
            exit 1
          fi
          echo "✅ FVM successfully uninstalled"

      - name: Test uninstall on clean system (idempotency)
        run: ./scripts/install.sh --uninstall

  # Test container detection (runs as root inside docker but should be allowed)
  test-container:
    name: Test Container
    needs: validate
    runs-on: ubuntu-latest
    container: ubuntu:latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          apt-get update && apt-get install -y curl tar gzip
      
      - name: Test container root allowed
        run: |
          set -euo pipefail
          ./scripts/install.sh
          "$HOME/.fvm_flutter/bin/fvm" --version
          ./scripts/install.sh --uninstall
