name: Test Install Script

on:
  push:
    paths:
      - 'scripts/install.sh'
      - 'scripts/uninstall.sh'
      - 'docs/public/install.sh'
      - 'docs/public/uninstall.sh'
      - '.github/workflows/test-install.yml'
  pull_request:
    paths:
      - 'scripts/install.sh'
      - 'scripts/uninstall.sh'
      - 'docs/public/install.sh'
      - 'docs/public/uninstall.sh'
      - '.github/workflows/test-install.yml'
  workflow_dispatch:

jobs:
  # Basic validation - shellcheck and parity
  validate:
    name: Validate Scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install shellcheck
        run: |
          if ! command -v shellcheck &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y shellcheck
          fi
      - name: Shellcheck install.sh
        run: shellcheck scripts/install.sh
      - name: Shellcheck uninstall.sh
        run: shellcheck scripts/uninstall.sh

      - name: Verify install.sh parity
        run: |
          diff scripts/install.sh docs/public/install.sh || {
            echo "❌ scripts/install.sh and docs/public/install.sh differ!"
            exit 1
          }
          echo "✅ install.sh files are in sync"

      - name: Verify uninstall.sh parity
        run: |
          diff scripts/uninstall.sh docs/public/uninstall.sh || {
            echo "❌ scripts/uninstall.sh and docs/public/uninstall.sh differ!"
            exit 1
          }
          echo "✅ uninstall.sh files are in sync"

  # Test install.sh (v2 - user-local only)
  test-install:
    name: Test install.sh - ${{ matrix.os }}
    needs: validate
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, ubuntu-22.04, macos-latest, macos-15]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Test help and version flags
        run: |
          ./scripts/install.sh --help | grep -q "FVM Installer"
          ./scripts/install.sh --version | grep -q "install_fvm.sh version"
          echo "✅ Help and version flags work"

      - name: Test installation
        run: |
          ./scripts/install.sh
          export PATH="$HOME/fvm/bin:$PATH"
          fvm --version

      - name: Test reinstall (idempotency)
        run: |
          ./scripts/install.sh
          export PATH="$HOME/fvm/bin:$PATH"
          fvm --version

      - name: Test uninstall
        run: |
          export PATH="$HOME/fvm/bin:$PATH"
          which fvm
          ./scripts/install.sh --uninstall

          # Verify uninstall - only bin/ should be removed
          if [[ -d ~/fvm/bin ]]; then
            echo "❌ FVM bin directory still exists after uninstall"
            exit 1
          fi
          echo "✅ FVM successfully uninstalled"

      - name: Test uninstall on clean system (idempotency)
        run: ./scripts/install.sh --uninstall

      - name: Test specific version installation
        run: |
          # Install specific version (use a known stable version)
          ./scripts/install.sh 3.2.1

          # Verify correct version installed
          export PATH="$HOME/fvm/bin:$PATH"
          fvm_version=$(fvm --version)
          echo "Installed version: $fvm_version"

          # Version should contain 3.2.1
          echo "$fvm_version" | grep -q "3.2.1" || { echo "❌ Wrong version installed"; exit 1; }
          echo "✅ Specific version installation successful"

          # Clean up for next tests
          ./scripts/install.sh --uninstall

      - name: Test custom install location (FVM_INSTALL_DIR)
        run: |
          export FVM_INSTALL_DIR="$HOME/fvm-install-test"
          mkdir -p "$FVM_INSTALL_DIR/versions/stable"
          echo "cached sdk" > "$FVM_INSTALL_DIR/versions/stable/marker"

          ./scripts/install.sh
          export PATH="$FVM_INSTALL_DIR/bin:$PATH"
          fvm --version

          ./scripts/install.sh --uninstall

          # Verify uninstall - only bin/ should be removed
          if [[ -d "$FVM_INSTALL_DIR/bin" ]]; then
            echo "❌ FVM bin directory still exists after uninstall"
            exit 1
          fi

          # Cached SDKs should survive
          if [[ ! -f "$FVM_INSTALL_DIR/versions/stable/marker" ]]; then
            echo "❌ Cached SDKs were deleted!"
            exit 1
          fi
          echo "✅ Custom install location test successful"

  # Test old v1 installation detection (warning-only, no auto-delete)
  test-old-installation-warning:
    name: Test Old Installation Warning - ${{ matrix.os }}
    needs: validate
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Simulate old v1 installation
        run: |
          # Create old v1 structure
          mkdir -p ~/.fvm_flutter/bin
          echo '#!/bin/bash' > ~/.fvm_flutter/bin/fvm
          echo 'echo "fake v1 fvm"' >> ~/.fvm_flutter/bin/fvm
          chmod +x ~/.fvm_flutter/bin/fvm

          # Create old system symlink (if sudo available)
          if command -v sudo >/dev/null 2>&1; then
            sudo ln -sf ~/.fvm_flutter/bin/fvm /usr/local/bin/fvm
            echo "SYSTEM_SYMLINK_CREATED=true" >> $GITHUB_ENV
            echo "✅ Created system symlink"
          else
            echo "SYSTEM_SYMLINK_CREATED=false" >> $GITHUB_ENV
            echo "ℹ️ Skipping system symlink (no sudo)"
          fi

          # Create some cached SDKs (should survive)
          mkdir -p ~/fvm/versions/stable
          echo "cached sdk" > ~/fvm/versions/stable/marker

          echo "✅ Old installation simulation ready"
          ls -la ~/.fvm_flutter/bin/
          ls -la ~/fvm/versions/

      - name: Run installer and capture output
        run: |
          output=$(./scripts/install.sh 2>&1)
          echo "$output"
          echo "$output" > /tmp/install_output.txt
          echo "✅ Installation complete"

      - name: Verify warning-only behavior
        run: |
          # Old directories should STILL EXIST (we warn, not delete)
          if [ ! -d ~/.fvm_flutter ]; then
            echo "❌ Old ~/.fvm_flutter was deleted (should be warning-only)"
            exit 1
          fi
          echo "✅ Old directory preserved (warning-only)"

          # Verify warning was displayed
          if grep -q "Old FVM" /tmp/install_output.txt; then
            echo "✅ Warning about old installation displayed"
          else
            echo "❌ Expected warning about old installation"
            exit 1
          fi

          # Check system symlink warning if it was created
          if [ "$SYSTEM_SYMLINK_CREATED" = "true" ]; then
            if [ -e /usr/local/bin/fvm ]; then
              echo "✅ Old symlink preserved (warning-only)"
            fi
          fi

          # New binary should exist
          if [ ! -f ~/fvm/bin/fvm ]; then
            echo "❌ New binary not found at ~/fvm/bin/fvm"
            exit 1
          fi
          echo "✅ New binary installed at ~/fvm/bin/fvm"

          # Cached SDKs should survive
          if [ ! -f ~/fvm/versions/stable/marker ]; then
            echo "❌ Cached SDKs were deleted!"
            exit 1
          fi
          echo "✅ Cached SDKs preserved"

          # Verify binary works
          ~/fvm/bin/fvm --version
          echo "✅ Old installation warning test complete"

  # Test install.sh in container (root allowed with warning)
  test-container:
    name: Test install.sh in Container
    needs: validate
    runs-on: ubuntu-latest
    container: ubuntu:latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: apt-get update && apt-get install -y curl tar gzip

      - name: Test container root install (should warn but succeed)
        run: |
          output=$(./scripts/install.sh 2>&1)
          echo "$output"

          # Should show warning
          if echo "$output" | grep -q "Running as root"; then
            echo "✅ Root warning displayed"
          else
            echo "❌ Expected root warning"
            exit 1
          fi

          # Should still succeed
          $HOME/fvm/bin/fvm --version
          echo "✅ Container install successful"

  # Test install.sh root permissions (warns but allows)
  test-permissions:
    name: Test install.sh Root Warning
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Test root shows warning but succeeds
        run: |
          output=$(sudo -H ./scripts/install.sh 2>&1)
          echo "$output"

          # Should show warning
          if echo "$output" | grep -q "Running as root"; then
            echo "✅ Root warning displayed"
          else
            echo "❌ Expected root warning"
            exit 1
          fi

          # Should succeed
          sudo -H /root/fvm/bin/fvm --version
          echo "✅ Root install successful"
