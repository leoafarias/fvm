name: Deploy Release

on:
  release:
    types: [published]
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to deploy (e.g., v4.0.0-beta.2)'
        required: true

env:
  PUB_CREDENTIALS: ${{ secrets.PUB_CREDENTIALS }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  test:
    name: Test
    uses: ./.github/workflows/test.yml

  validate:
    name: Validate Release
    needs: test
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract-version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from release or input
        id: extract-version
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="${{ github.event.inputs.release_tag }}"
          fi
          # Remove 'v' prefix if present
          VERSION=${VERSION#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "üöÄ Validating version: $VERSION"

      - name: Update pubspec.yaml version
        run: |
          echo "üìù Updating pubspec.yaml version to $RELEASE_VERSION"
          sed -i "s/^version: .*/version: $RELEASE_VERSION/" pubspec.yaml
          echo "‚úÖ Updated version:"
          grep "^version:" pubspec.yaml

      - name: Prepare environment
        uses: ./.github/actions/prepare

      - name: Generate version.dart
        run: |
          echo "üî® Generating version.dart with build_runner"
          dart run build_runner build --delete-conflicting-outputs
          echo "‚úÖ Generated version.dart content:"
          cat lib/src/version.dart

      - name: Validate pub.dev package (dry run)
        run: |
          echo "üîç Validating package for pub.dev..."
          dart pub publish --dry-run
          echo "‚úÖ Package validation successful!"

  deploy:
    name: Deploy Core
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set version from validation
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "üöÄ Deploying version: $VERSION"
          sed -i "s/^version: .*/version: $RELEASE_VERSION/" pubspec.yaml

      - name: Prepare environment
        uses: ./.github/actions/prepare

      - name: Generate version.dart
        run: dart run build_runner build --delete-conflicting-outputs

      # Skip pkg-github-release - release already exists
      - name: Deploy Linux binaries to existing release
        run: dart run grinder pkg-github-linux

      - name: Deploy to Pub
        run: dart run grinder pkg-pub-deploy

  deploy-windows:
    name: Deploy Windows
    runs-on: windows-latest
    needs: validate
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      CHOCOLATEY_TOKEN: ${{ secrets.CHOCOLATEY_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set version from validation
        run: |
          $VERSION = "${{ needs.validate.outputs.version }}"
          echo "RELEASE_VERSION=$VERSION" | Out-File -FilePath $env:GITHUB_ENV -Append
          echo "üîÑ Setting version to: $VERSION"
          # Update pubspec.yaml to match
          (Get-Content pubspec.yaml) -replace '^version: .*', "version: $VERSION" | Set-Content pubspec.yaml

      - name: Prepare environment
        uses: ./.github/actions/prepare

      - name: Deploy Windows binaries to existing release
        run: dart run grinder pkg-github-windows

      - name: Deploy Chocolatey
        run: dart run grinder pkg-chocolatey-deploy

  deploy-macos:
    name: Deploy macOS
    runs-on: macos-latest
    needs: validate
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set version from validation
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "üîÑ Setting version to: $VERSION"
          # Update pubspec.yaml to match
          sed -i '' "s/^version: .*/version: $VERSION/" pubspec.yaml

      - name: Prepare environment
        uses: ./.github/actions/prepare

      - name: Deploy macOS binaries to existing release
        run: dart run grinder pkg-github-macos

      - name: Deploy versioned Homebrew formula
        run: dart run grinder pkg-homebrew-update --versioned-formula
        env:
          GITHUB_TOKEN: ${{ secrets.HOMEBREW_FVM_GH_TOKEN }}

      - name: Deploy Homebrew
        run: dart run grinder pkg-homebrew-update
        env:
          GITHUB_TOKEN: ${{ secrets.HOMEBREW_FVM_GH_TOKEN }}

  deploy-docker:
    name: Deploy Docker
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set version for Docker
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "üê≥ Building Docker image for version: $VERSION"

      - name: Prepare environment
        uses: ./.github/actions/prepare

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          file: ./.docker/Dockerfile
          push: true
          tags: leoafarias/fvm:${{ env.RELEASE_VERSION }}