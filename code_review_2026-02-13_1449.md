# Code Review - PR #965: Add fvm MCP server package

**Date**: 2026-02-13
**Branch**: fvm-mcp â†’ main
**Files**: 21 changed (+2718, -37)

## Summary

| Category | Total | Blockers | Should Fix | Notes |
|----------|-------|----------|------------|-------|
| Code Quality | 9 | 0 | 6 | 3 |
| AI Slop | 4 | 0 | 2 | 2 |
| **Combined** | **13** | **0** | **8** | **5** |

**Verdict**: No blockers. Solid alpha-quality package with good architecture. 8 items worth addressing before GA.

---

## Part 1: Code Quality

### Should Fix (6)

**F1** - Clarity - `fvm_mcp/lib/src/server.dart:90-429`

Tool registration is implemented as large repetitive imperative blocks. `_registerJsonApiTools`, `_registerMutatingTools`, and `_registerProxyTools` inline many near-identical `_tool(...)` calls with duplicated schema/arg/timeout patterns, increasing cognitive load and edit risk.

**Action**: Convert registrations to a declarative ToolSpec list and generate tool wiring through shared builders.

---

**F2** - ControlFlow - `fvm_mcp/lib/src/process_runner.dart:36-148`

`_runCore` is a monolithic ~110-line method with multiple responsibilities: process spawning, stdout/stderr collection, progress notifications, timeout escalation, and result formatting.

**Action**: Split into focused helpers (spawn/collect, timeout handling, progress emission, result formatting) and simplify with guard clauses.

---

**F3** - Consistency - `fvm_mcp/lib/src/version.dart:98` vs `fvm_mcp/lib/src/process_runner.dart:24`

Version detection hardcodes `runInShell: true`, while `ProcessRunner` defaults `runInShell` to `Platform.isWindows`. Startup fails when detection returns unknown. Inconsistent shell-launch policy between detection and execution.

**Action**: Use one shared process-launch policy for detection and execution (inject config/runner into detection).

---

**F4** - Consistency - `fvm_mcp/lib/src/arg_utils.dart:9-48`

Argument type handling is inconsistent: `opt<T>()` throws `ArgumentError` on type mismatch (line 20), but `stringArg`/`boolArg`/`listArg` return null/empty or silently filter values.

**Action**: Standardize validation behavior (prefer strict errors for invalid types) across all arg extractors.

---

**F5** - Debt - `fvm_mcp/lib/src/server.dart:84-429`

Critical server registration/gating logic is untested. Tests only cover `arg_utils`, `process_runner`, and `version`. No server-level test for tool availability by FVM version, schema enforcement, or argument-to-command mapping.

**Action**: Add server tests for tool availability by FVM version, schema enforcement, and argument-to-command mapping.

---

**F6** - Debt - `.github/workflows/release-fvm-mcp.yml:73-95`

Release validation scrapes Dart source text via `awk`/`sed` for version data, creating fragile CI coupling. Version is duplicated across `pubspec.yaml` and `server.dart`.

**Action**: Use pubspec as single source of truth and inject version at build time via `--define`; remove sed-based Dart source parsing.

---

### Notes (3)

**F7** - Debt - `.github/workflows/test.yml:160-162`

Integration-test skip depends on a specific branch name (`fvm-mcp`). This is fragile and won't scale.

**Action**: Replace branch-name logic with path/label-based gating.

---

**F8** - Clarity - `fvm_mcp/lib/src/process_runner.dart:117`

Timeout error text uses `timeout.inMinutes`, reporting "Timeout after 0m" for sub-minute timeouts (codified in test expectation at `process_runner_test.dart:96`).

**Action**: Format durations adaptively (ms/s/min) for clearer diagnostics.

---

**F9** - OverEngineering - `fvm_mcp/lib/src/process_runner.dart:154-166`

`runJsonApi` is a thin pass-through to `_runCore` with zero behavioral differentiation from `run` (minus `--fvm-skip-input`).

**Action**: Collapse into a single `run` API with an explicit mode flag, or document intended divergence if kept.

---

## Part 2: AI Slop Analysis

### Executive Summary
- Lines analyzed: 1027
- AI-generated code likelihood: **low**
- Total findings: 4 (all confirmed)
- Action required: minor cleanup only

### Findings

**S1** (OverDefensive, NOTE) - `server.dart:377` - `fvm.exec` handler

Schema marks `command` as `required` with `minLength: 1`, but handler re-checks `command == null`. The null branch is unreachable dead code since schema validation runs first.

**Action**: Delete the manual null-check; use `stringArg(call, 'command')!` directly.

---

**S2** (OverDefensive, NOTE) - `server.dart:406` - `fvm.spawn` handler

Same pattern: `version` is schema-required with `minLength: 1`, but handler re-checks `version == null`. Dead code duplication.

**Action**: Remove the runtime null-guard; consume schema-validated input directly.

---

**S3** (AvoidRefactor, SHOULD_FIX) - `server.dart:90` - JSON API tools

JSON API tool registrations (`list`, `releases`, `context`, `project`) repeat identical `compress` schema definition and `--compress` flag wiring. Invites drift when updating descriptions.

**Action**: Extract shared JSON-API schema composition helper for `compress` (plus per-tool extras).

---

**S4** (AvoidRefactor, SHOULD_FIX) - `server.dart:333` - Proxy tools

`fvm.flutter` and `fvm.dart` registrations are near-clones (identical schema, timeout, cwd/meta wiring). Only the subcommand name differs.

**Action**: Create a shared proxy-registration helper parameterized by tool name, then register both through it.

---

## All Actionable Items

| # | Source | Severity | Location | Issue | Action |
|---|--------|----------|----------|-------|--------|
| F1 | Quality | SHOULD_FIX | server.dart:90-429 | Repetitive tool registration blocks | Declarative ToolSpec list |
| F2 | Quality | SHOULD_FIX | process_runner.dart:36-148 | Monolithic _runCore method | Split into focused helpers |
| F3 | Quality | SHOULD_FIX | version.dart:98 | Inconsistent shell-launch policy | Shared process-launch config |
| F4 | Quality | SHOULD_FIX | arg_utils.dart:9-48 | Inconsistent arg validation | Standardize error behavior |
| F5 | Quality | SHOULD_FIX | server.dart:84-429 | No server-level tests | Add integration tests |
| F6 | Quality | SHOULD_FIX | release-fvm-mcp.yml:73-95 | Fragile sed-based version scraping | Inject version at build time |
| S3 | Slop | SHOULD_FIX | server.dart:90 | Duplicated compress schema/flag | Extract shared helper |
| S4 | Slop | SHOULD_FIX | server.dart:333 | Near-clone proxy registrations | Shared proxy builder |
| F7 | Quality | NOTE | test.yml:160-162 | Branch-name-based skip | Path/label gating |
| F8 | Quality | NOTE | process_runner.dart:117 | "Timeout after 0m" message | Adaptive duration format |
| F9 | Quality | NOTE | process_runner.dart:154-166 | Thin runJsonApi pass-through | Collapse or document |
| S1 | Slop | NOTE | server.dart:377 | Unreachable null-check (fvm.exec) | Delete dead guard |
| S2 | Slop | NOTE | server.dart:406 | Unreachable null-check (fvm.spawn) | Delete dead guard |
