{"assignees":[{"id":"MDQ6VXNlcjQzNTgzMw==","login":"leoafarias","name":"Leo Farias"},{"id":"BOT_kgDOC9w8XQ","login":"Copilot","name":""}],"author":{"is_bot":true,"login":"app/copilot-swe-agent"},"body":"Thanks for asking me to work on this. I will get started on it and keep this PR's description up to date as I form a plan and make progress.\n\nOriginal description:\n\n> Implement robustness improvements to scripts/install.sh and keep docs/public/install.sh in sync. Also extend CI to validate musl-based Linux (Alpine) and ensure tests remain valid.\n> \n> Summary of changes to implement:\n> \n> 1) Normalize tag vs. filename version and support musl assets with fallbacks\n> - After resolving FVM_VERSION (either provided or fetched):\n>   - Compute VERSION_NO_V=\"${FVM_VERSION#v}\" and TAG=\"v$VERSION_NO_V\".\n>   - Detect musl on Linux:\n>     - MUSL_SUFFIX=\"\"\n>     - If OS==linux and ldd exists and `ldd --version` contains \"musl\", set MUSL_SUFFIX=\"-musl\".\n>   - Build primary URL using TAG for the release path, and VERSION_NO_V for the filename:\n>     URL=\"https://github.com/leoafarias/fvm/releases/download/$TAG/fvm-$VERSION_NO_V-$OS-$ARCH$MUSL_SUFFIX.tar.gz\"\n>   - Download logic fallbacks:\n>     - First attempt URL above.\n>     - If it fails AND MUSL_SUFFIX was set, retry without MUSL suffix.\n>     - If that still fails, try filename using TAG in the filename (v-prefixed) to be resilient if assets were published with v in the name:\n>       URL=\"https://github.com/leoafarias/fvm/releases/download/$TAG/fvm-$TAG-$OS-$ARCH$MUSL_SUFFIX.tar.gz\" (and the non-musl variant if needed).\n> \n> 2) Create /usr/local/bin with privilege escalation if missing\n> - Current logic errors for non-root when the directory is absent. Change to:\n>   if [[ ! -d \"$SYMLINK_DIR\" ]]; then\n>     if [[ \"$IS_ROOT\" == \"true\" ]]; then\n>       mkdir -p \"$SYMLINK_DIR\" || error \"Failed to create directory: $SYMLINK_DIR\"\n>     else\n>       \"$ESCALATION_TOOL\" mkdir -p \"$SYMLINK_DIR\" || error \"Failed to create directory: $SYMLINK_DIR\"\n>     fi\n>     info \"Created directory: $SYMLINK_DIR\"\n>   fi\n> \n> 3) Fish PATH export improvement\n> - Prefer fish_add_path -g (fish 3.2+) with a safe fallback string (set -gx PATH ...) if needed. Since we canâ€™t detect fish features at edit time, change get_path_export fish branch to:\n>   echo \"fish_add_path -g $FVM_DIR_BIN\"\n> \n> 4) Precise symlink handling on uninstall\n> - Only remove the symlink if it points to \"$FVM_DIR_BIN/fvm\". Update both detection (for fvm_found) and removal to check readlink target equals \"$FVM_DIR_BIN/fvm\". If it points elsewhere, print a warning and skip removal.\n> \n> 5) Keep docs/public/install.sh identical to scripts/install.sh\n> - Update docs/public/install.sh with the exact same content as scripts/install.sh (tests assert exact match).\n> \n> 6) CI: Add Alpine-based job to validate musl path\n> - In .github/workflows/test-install.yml add a new job (e.g., test-alpine) that runs in container: alpine:latest with steps:\n>   - apk add --no-cache bash curl tar gzip coreutils\n>   - Run the install script using bash: /bin/bash -lc './scripts/install.sh'\n>   - Verify /usr/local/bin/fvm --version\n> \n> Files to modify:\n> - scripts/install.sh (implement all changes above)\n> - docs/public/install.sh (keep in sync; identical content)\n> - .github/workflows/test-install.yml (add Alpine job)\n> \n> Acceptance criteria:\n> - Existing jobs continue to pass.\n> - New Alpine job installs successfully and fvm --version runs.\n> - Shellcheck still passes on scripts/install.sh.\n> - Dart tests validating parity between scripts/install.sh and docs/public/install.sh continue to pass.\n> \n> Notes:\n> - Do not change public invocation API, flags, or messages relied on by tests (e.g., the root-blocking message substring used in grep).\n> - Keep OS mapping as macos (current artifacts use macos).\n> - Maintain current help/usage text and environment variable FVM_ALLOW_ROOT documentation.\n> \n\n\n\n<!-- START COPILOT CODING AGENT SUFFIX -->\n\n*This pull request was created as a result of the following prompt from Copilot chat.*\n> Implement robustness improvements to scripts/install.sh and keep docs/public/install.sh in sync. Also extend CI to validate musl-based Linux (Alpine) and ensure tests remain valid.\n> \n> Summary of changes to implement:\n> \n> 1) Normalize tag vs. filename version and support musl assets with fallbacks\n> - After resolving FVM_VERSION (either provided or fetched):\n>   - Compute VERSION_NO_V=\"${FVM_VERSION#v}\" and TAG=\"v$VERSION_NO_V\".\n>   - Detect musl on Linux:\n>     - MUSL_SUFFIX=\"\"\n>     - If OS==linux and ldd exists and `ldd --version` contains \"musl\", set MUSL_SUFFIX=\"-musl\".\n>   - Build primary URL using TAG for the release path, and VERSION_NO_V for the filename:\n>     URL=\"https://github.com/leoafarias/fvm/releases/download/$TAG/fvm-$VERSION_NO_V-$OS-$ARCH$MUSL_SUFFIX.tar.gz\"\n>   - Download logic fallbacks:\n>     - First attempt URL above.\n>     - If it fails AND MUSL_SUFFIX was set, retry without MUSL suffix.\n>     - If that still fails, try filename using TAG in the filename (v-prefixed) to be resilient if assets were published with v in the name:\n>       URL=\"https://github.com/leoafarias/fvm/releases/download/$TAG/fvm-$TAG-$OS-$ARCH$MUSL_SUFFIX.tar.gz\" (and the non-musl variant if needed).\n> \n> 2) Create /usr/local/bin with privilege escalation if missing\n> - Current logic errors for non-root when the directory is absent. Change to:\n>   if [[ ! -d \"$SYMLINK_DIR\" ]]; then\n>     if [[ \"$IS_ROOT\" == \"true\" ]]; then\n>       mkdir -p \"$SYMLINK_DIR\" || error \"Failed to create directory: $SYMLINK_DIR\"\n>     else\n>       \"$ESCALATION_TOOL\" mkdir -p \"$SYMLINK_DIR\" || error \"Failed to create directory: $SYMLINK_DIR\"\n>     fi\n>     info \"Created directory: $SYMLINK_DIR\"\n>   fi\n> \n> 3) Fish PATH export improvement\n> - Prefer fish_add_path -g (fish 3.2+) with a safe fallback string (set -gx PATH ...) if needed. Since we canâ€™t detect fish features at edit time, change get_path_export fish branch to:\n>   echo \"fish_add_path -g $FVM_DIR_BIN\"\n> \n> 4) Precise symlink handling on uninstall\n> - Only remove the symlink if it points to \"$FVM_DIR_BIN/fvm\". Update both detection (for fvm_found) and removal to check readlink target equals \"$FVM_DIR_BIN/fvm\". If it points elsewhere, print a warning and skip removal.\n> \n> 5) Keep docs/public/install.sh identical to scripts/install.sh\n> - Update docs/public/install.sh with the exact same content as scripts/install.sh (tests assert exact match).\n> \n> 6) CI: Add Alpine-based job to validate musl path\n> - In .github/workflows/test-install.yml add a new job (e.g., test-alpine) that runs in container: alpine:latest with steps:\n>   - apk add --no-cache bash curl tar gzip coreutils\n>   - Run the install script using bash: /bin/bash -lc './scripts/install.sh'\n>   - Verify /usr/local/bin/fvm --version\n> \n> Files to modify:\n> - scripts/install.sh (implement all changes above)\n> - docs/public/install.sh (keep in sync; identical content)\n> - .github/workflows/test-install.yml (add Alpine job)\n> \n> Acceptance criteria:\n> - Existing jobs continue to pass.\n> - New Alpine job installs successfully and fvm --version runs.\n> - Shellcheck still passes on scripts/install.sh.\n> - Dart tests validating parity between scripts/install.sh and docs/public/install.sh continue to pass.\n> \n> Notes:\n> - Do not change public invocation API, flags, or messages relied on by tests (e.g., the root-blocking message substring used in grep).\n> - Keep OS mapping as macos (current artifacts use macos).\n> - Maintain current help/usage text and environment variable FVM_ALLOW_ROOT documentation.\n> \n\n<!-- START COPILOT CODING AGENT TIPS -->\n---\n\nðŸ’¡ You can make Copilot smarter by setting up custom instructions, customizing its development environment and configuring Model Context Protocol (MCP) servers. Learn more [Copilot coding agent tips](https://gh.io/copilot-coding-agent-tips) in the docs.","closedAt":"2025-09-12T15:08:46Z","comments":[{"id":"IC_kwDOCkCuKM7D1MHN","author":{"login":"vercel"},"authorAssociation":"NONE","body":"[vc]: #NMg1LEkQU6MNNrUAl9L5JM7X6Or36wwJqJ0QaY2tcjw=:eyJpc01vbm9yZXBvIjp0cnVlLCJ0eXBlIjoiZ2l0aHViIiwicHJvamVjdHMiOlt7Im5hbWUiOiJmdm0iLCJpbnNwZWN0b3JVcmwiOiJodHRwczovL3ZlcmNlbC5jb20vZmx1dHRlcnRvb2xzL2Z2bS82WUM1YTNhOUJndXMzV052S0JEYXlGQ2V5THVzIiwicHJldmlld1VybCI6IiIsIm5leHRDb21taXRTdGF0dXMiOiJGQUlMRUQiLCJsaXZlRmVlZGJhY2siOnsicmVzb2x2ZWQiOjAsInVucmVzb2x2ZWQiOjAsInRvdGFsIjowLCJsaW5rIjoiIn0sInJvb3REaXJlY3RvcnkiOiJkb2NzIn1dfQ==\nThe latest updates on your projects. Learn more about [Vercel for GitHub](https://vercel.link/github-learn-more).\n\n| Project | Deployment | Preview | Comments | Updated (UTC) |\n| :--- | :----- | :------ | :------- | :------ |\n| [fvm](https://vercel.com/fluttertools/fvm) | ![Error](https://vercel.com/static/status/error.svg) [Error](https://vercel.com/fluttertools/fvm/6YC5a3a9Bgus3WNvKBDayFCeyLus) |  |  | Sep 12, 2025 2:25pm |\n\n","createdAt":"2025-09-12T14:25:07Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/leoafarias/fvm/pull/907#issuecomment-3285500365","viewerDidAuthor":false}],"createdAt":"2025-09-12T14:25:05Z","labels":[],"number":907,"state":"CLOSED","title":"[WIP] Improve install.sh robustness (version tag normalization, musl support, symlink dir creation, precise uninstall) + add Alpine CI validation","updatedAt":"2025-09-12T15:08:46Z","url":"https://github.com/leoafarias/fvm/pull/907"}
